<svg xmlns="http://www.w3.org/2000/svg"
     xmlns:xlink="http://www.w3.org/1999/xlink"
     width="700"
     viewBox="100 100 600 400"
     onload="InitDraw(evt)"
     onmousedown="Grab(evt)"
     onmousemove="Drag(evt)"
     onmouseup="Drop(evt)"
	 onclick="ToggleCircles(evt)"
     style="cursor:pointer">

  <style>
    .draggable { cursor: move; }
  </style>

  <defs>
    <g id="circ">
      <circle cx="0" cy="0" r="25"
              fill="#A9C228" stroke="black"/>
    </g>
  </defs>

  <rect x="0" y="0" width="800" height="600"
        fill="#f8f8f8"/>

<script><![CDATA[

let svg;
let dragTarget = null;
let grabOffset = { x: 0, y: 0 };
let circles = [];
let hide = true;

function InitDraw(evt) {
  svg = evt.target;
  createUse("Circle1", 200, 300);
  createUse("Circle2", 500, 300);
  for (let i = 0; i < 8; i++) {
    let c = createCircle(200, 255, 15);
    c.setAttribute("transform", `rotate(${i*45},200,300)`);
    circles.push(c);
  }

  for (let i = 0; i < 6; i++) {
    let c = createCircle(500, 220, 37);
    c.setAttribute("transform", `rotate(${i*60},500,300)`);
    circles.push(c);
  }
}

function createUse(id, x, y) {
  let u = document.createElementNS(svg.namespaceURI, "use");
  u.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#circ");
  u.setAttribute("transform", `translate(${x},${y})`);
  u.setAttribute("id", id);
  u.classList.add("draggable");   // ğŸ”‘ NA <use>
  svg.appendChild(u);
}

/* ğŸ”‘ poiÅ¡Äi pravi <use> */
function findDraggableUse(el) {
  while (el && el.tagName !== "svg") {
    if (el.tagName === "use" && el.classList.contains("draggable")) {
      return el;
    }
    el = el.parentNode;
  }
  return null;
}

/* pravilna pretvorba koordinat */
function getSVGPoint(evt) {
  const pt = svg.createSVGPoint();
  pt.x = evt.clientX;
  pt.y = evt.clientY;
  return pt.matrixTransform(svg.getScreenCTM().inverse());
}

function Grab(evt) {
  const target = findDraggableUse(evt.target);
  if (!target) return;

  dragTarget = target;
  svg.appendChild(dragTarget);

  const p = getSVGPoint(evt);
  const m = dragTarget.transform.baseVal.consolidate();
  const tx = m ? m.matrix.e : 0;
  const ty = m ? m.matrix.f : 0;

  grabOffset.x = p.x - tx;
  grabOffset.y = p.y - ty;
}

function Drag(evt) {
  if (!dragTarget) return;

  const p = getSVGPoint(evt);
  dragTarget.setAttribute(
    "transform",
    `translate(${p.x - grabOffset.x},${p.y - grabOffset.y})`
  );
}

function Drop() {
  dragTarget = null;
}

function createCircle(cx, cy, r) {
  let c = document.createElementNS(svg.namespaceURI, "circle");
  c.setAttribute("cx", cx);
  c.setAttribute("cy", cy);
  c.setAttribute("r", r);
  c.setAttribute("fill", "#CCD3D9");
  c.setAttribute("stroke", "black");
  svg.appendChild(c);
  return c;
}

function ToggleCircles(evt) {
  if (evt.target.classList.contains("draggable")) return;

  circles.forEach(c =>
    c.setAttribute("opacity", hide ? 0 : 1)
  );
  hide = !hide;
}

]]></script>
</svg>
